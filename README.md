**Правила для штор**

*curtains_wb-mr6c.js и curtains_wb-do-r10r.js*

Правила создают виртуальные шторы, % открытия которых вычисляется из времени их открытия/закрытия - например, если у штор нет дачиков положения.

В виртуальное устройство добавлен функционал управляющей команды для упрощшения интеграции с системами умного дома (например, HomeAssistant)

Так как контроль штор на оборудовании Wirenboard возможен как через "умное" реле типа WV-MR6C (рекомендовано Wirenboard), так и через модуль ввода-вывода WB-DO-R10R (устарешвий вариант), присутвует два варианта правил под каждое из устройств.
Они отличаются тем, что в реле WB-MR используется шаблон "шторы", который создает два выключателя - на открытие и на закрытие штор. В таком режиме всеми задержками при прееключении направления управляет прошивка реле на основании данных из шаблона, где задается тайм-уат переключения направлений.
В случае с WB-DO-R10R имеется переключатель направления штор и переключатель питания мотора. В этом случае задержками при переключении реле управляет само правило - тайм-ауты задаются в коде (нужные места подсвечены подсвечены комментариями). По умолчанияю выставлено 50мс.

В случае с вариантом WB-MR6C в шаблоне реле рекомендую указать время открытия/закрытия штор на 1 секунду больше реального, а в правиле задать реальное время открытия/закрытия. Это позволит точно управлять положением шторы без преждеверменного выключения, но при этом будет присутствовать дополнительная защита на случай непредвиденных сбоев контроллера.

В данном шаблоне подразумевается использование отдельных входов выключателей (Discrete inputs). Если контроль подразумевается через встроенные в реле входы через mapping-мтарицу, то вместо адресов выключателей можно подставить любые "заглушки", или указать неиспользуемые входы.

Для создания виртуального устройства необходимо на вход задать следующие параметры:
- ID уст-ва - уникальный номер устройства, будет использован в имени устройства (имена будут вида "virtual-rollet-1", "virtual-rollet-2" и т.д.)
- Наименование - человекочитаемое название устройства (например, "Штора в гостиной")
- Канал открытия шторы (для WB-MR6C)/Канал управления мотором (для WB-DO-R10R) - Канал переключателя для открытия шторы/управления мотором
- Канал закрытия шторы (для WB-MR6C)/Канал управления направлением (для WB-DO-R10R) - Канал переключателя для закрытия шторы/управления направлением
- Время на полное открытие/закрытые - время полного октрытия и закрытия шторы в МС. Подразумевается, что время октрытия и время закрытия - одинаковое
- Канал выключателй "Вверх" - Канал кнопки, при нажатии на которую штора должна подниматься
- Канал выключателя "Вниз" - Канал кнопки, при нажатии на которую штора должна опускаться
- Признак фиксируемых кнопок - Указваем "true", если кнопки с фиксацией положения. Если кнопки без фиксации - не указываем ничего.

**Правило для радиаторов**

*radiators.js*

Правило создает виртуальные устройства, управляющие электроприводом радиаторов (в примере - нормально-открытыми).
Логика следующая: 
- Когда реальная температура становится выше заданной + гистерезис, то подается напряжение на термоголовку и прекращается подача теплоносителя.
- Когда реальная температура становится ниже заданной - гистерезис, то снимается напряжение с термоголовки и подача теплоносителя открывается.\
Для создания виртуального устройства необходимо на вход задать следующие параметры:
- ID уст-ва - уникальный номер устройства, будет использован в имени устройства (имена будут вида "ARA1", "ARA2" и т.д.)
- Наименование - человекочитаемое название устройства (например, "Радиатор - гостиная")
- Канал датчика реальной температуры - Указывается канал, по которому от термодатчика передается температура, на осоновании которой открывается или закрывается подача теплоносителя. Это может быть термодатчик на обратном клапане радиатора (температура "обратки"), термодатчик в помещении или термодатчик на самом радиаторе.
- Канал выключателя термоголовки - Указывается канал, по котрому идет управление термоголовкой. В текущей реализации - простой переключатель.

В созданном устройстве необходимо задать целевую температуру и гистерезис - дельту, при которой не происходит переключения термоголовки. По умолчанию гистерезис - 2 гардуса.

**Правило для мастер-выключателя**

*masterswitch.js*

Правило создает мастер-выключатель. Написано на основе примера с [cайта поддержки wirenboard](https://wiki.wirenboard.com/wiki/index.php?title=Rule_Examples&mobileaction=toggle_view_desktop#%D0%9C%D0%B0%D1%81%D1%82%D0%B5%D1%80-%D0%B2%D1%8B%D0%BA%D0%BB%D1%8E%D1%87%D0%B0%D1%82%D0%B5%D0%BB%D1%8C_%D1%81_%D0%B2%D0%BE%D1%81%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5%D0%BC_%D0%BF%D0%BE%D1%81%D0%BB%D0%B5%D0%B4%D0%BD%D0%B5%D0%B3%D0%BE_%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F).

Из оригинального кода убрана (заккоментирована) логика, отвечающая за сохранение состояния объектов.

Каналы управляемый объектов задаются напрямую в коде (начиная с 13 строки). Все объекты должны быть типа "пареключатель".

Привзяка к физической кнопке выключателя задается указанием канала в 47 строке кода.

В результате создается виртуальная кнопка, при нажатии на которую выключаются все заданные устройства.
